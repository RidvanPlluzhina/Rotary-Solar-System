#include <DFRobotDFPlayerMini.h>

#include "SoftwareSerial.h"
#include "DFRobotDFPlayerMini.h"

int rotaryPin = 2; // Pin D2 where the rotary part of the phone is connected
int buttonC = 7;   // Button C connected to D7
int buttonD = 6;   // Button D connected to D6

int pulseCount = 0; // Used for tracking the number of pulses generated by rotary dial
bool dialing = false; // Indicates if a number is currently being dialed
unsigned long lastPulseTime = 0; // Tracks the time of the last pulse to detect when dialing is complete

SoftwareSerial mySerial(10, 11); // RX, TX
DFRobotDFPlayerMini myDFPlayer;

void setup() {
  pinMode(rotaryPin, INPUT_PULLUP); 
  pinMode(buttonC, INPUT);
  pinMode(buttonD, INPUT);

  Serial.begin(9600); 
  Serial.println("Setup complete. Dial a number...");

  
  mySerial.begin(9600); 
  if (!myDFPlayer.begin(mySerial)) {
    Serial.println("DFPlayer Mini initialization failed!");
    while (true); 
  }
  myDFPlayer.volume(30); 
  Serial.println("MP3 Sound generating ready...");
}

void loop() {
  // Read rotary dial state
  int rotaryState = digitalRead(rotaryPin);
  
  // Start the call button
  if (digitalRead(buttonC) == HIGH) {
    Serial.println("LaunchRocket");
    myDFPlayer.play(1); 
    delay(200); // Debounce delay
  }
  
  // Stop the call button
  if (digitalRead(buttonD) == LOW) {
    Serial.println("StopEverything");
    myDFPlayer.play(2); 
    delay(200); // Debounce delay
  }

  if (rotaryState == LOW) {
    pulseCount++; // Increment pulse count on pulse
    lastPulseTime = millis(); // Record time of last pulse
    dialing = true; // Mark as dialing
  }

  if (dialing && millis() - lastPulseTime > 700) {
    int dialedNumber = -1; // Initialize with an invalid value

    // Map pulseCount ranges to dialed numbers
    if (pulseCount >= 10 && pulseCount <= 12) { 
      dialedNumber = 1; 
    } else if (pulseCount >= 13 && pulseCount <= 15) { 
      dialedNumber = 2; 
    } else if (pulseCount >= 16 && pulseCount <= 18) { 
      dialedNumber = 3; 
    } else if (pulseCount >= 19 && pulseCount <= 21) { 
      dialedNumber = 4; 
    } else if (pulseCount >= 22 && pulseCount <= 24) { 
      dialedNumber = 5; 
    } else if (pulseCount >= 25 && pulseCount <= 27) { 
      dialedNumber = 6; 
    } else if (pulseCount >= 28 && pulseCount <= 30) { 
      dialedNumber = 7; 
    } else if (pulseCount >= 31 && pulseCount <= 33) { 
      dialedNumber = 8; 
    } else if (pulseCount >= 34 && pulseCount <= 36) { 
      dialedNumber = 9; 
    } else if (pulseCount >= 37) { 
      dialedNumber = 0; 
    }

    // Print the detected number if valid
    if (dialedNumber != -1) {
      Serial.print("You have dialed: ");
      Serial.println(dialedNumber);

      // Add actions for each number
      if (dialedNumber == 0) {
        Serial.println("Earth"); // Message for Unity
        myDFPlayer.play(3); // Play 0003.mp3 from SD card
      } else if (dialedNumber == 1) {
        Serial.println("Mars"); // Message for Unity
        myDFPlayer.play(4); // Play 0004.mp3 from SD card
      } else if (dialedNumber == 2) {
        Serial.println("Sun"); // Message for Unity
        myDFPlayer.play(5); // Play 0005.mp3 from SD card
      } else if (dialedNumber == 3) {
        Serial.println("Mercury"); // Message for Unity
        myDFPlayer.play(6); // Play 0006.mp3 from SD card
      } else if (dialedNumber == 4) {
        Serial.println("Venus"); // Message for Unity
        myDFPlayer.play(7); // Play 0007.mp3 from SD card
      } else if (dialedNumber == 5) {
        Serial.println("Jupiter"); // Message for Unity
        myDFPlayer.play(8); // Play 0008.mp3 from SD card
      } else if (dialedNumber == 6) {
        Serial.println("Saturn"); // Message for Unity
        myDFPlayer.play(9); // Play 0009.mp3 from SD card
      } else if (dialedNumber == 7) {
        Serial.println("Uranus"); // Message for Unity
        myDFPlayer.play(10); // Play 0010.mp3 from SD card
      } else if (dialedNumber == 8) {
        Serial.println("Neptune"); // Message for Unity
        myDFPlayer.play(11); // Play 0011.mp3 from SD card
      } else if (dialedNumber == 9) {
        Serial.println("Moon"); // Message for Unity
        myDFPlayer.play(12); // Play 0012.mp3 from SD card

      } else {
        Serial.println("Error: Invalid pulse count!");
      }
    }

    // Reset counters for the next dial
    pulseCount = 0; 
    dialing = false; 
  }

  delay(50); // Small delay for stability
}
